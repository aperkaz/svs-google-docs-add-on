<!-- Load the jQuery library. -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<!-- Custom client-side JavaScript code. -->
<script>
    var user;
    var signatureId;

    // TODO Implement Login / Sign up functionality.
    $(function () {
        user = "test@gmail.com";
    });

    /**
     * Button click handlers.
     */
    $(function () {
        $('#sign-request').click(runSigning);
        $('#sign-place').click(runPlacing);
        $('#sign-new').click(runInitGui);
        $('#sign-again').click(runTryAgain);
    });


    /**
     * Runs a server-side function to request the signature.
     */
     function runSigning() {
         //this.disabled = true;
         changeState("state1", "state2");
         console.log("runSigning for user: %s", user); 
         
         google.script.run
             .withSuccessHandler(function (returnSuccess, element) {
                 console.log("Success: signature obtained (id: "+returnSuccess+")");
                 signatureId = returnSuccess; 
                 //element.disabled = false;
                 changeState("state2", "state4");
             })
             .withFailureHandler(function (msg, elements) {
                 console.log("Fail: signature was not obtained");
                 //element.disabled = false;
                 changeState("state2", "state3");
             })
             .withUserObject(this)
             .requestSignature(user);

     }
     
     /**
     * Runs a server-side function to place the signature in the document.
     */
     function runPlacing() {
          this.disabled = true;
          google.script.run
             .withSuccessHandler(function (returnSuccess, element) {
                 console.log("Success: document signed");
                 element.disabled = false;
                 changeState("state4", "state5");
             })
             .withFailureHandler(function (msg, elements) {
                 console.log("Fail: document was not signed");
                 elements.disabled = false;
                 changeState("state4", "state5");
             })
             .withUserObject(this)
             .signDocument(signatureId);
     }
     
     /**
     * Initialize the GUI (back to first page).
     */
     function runInitGui(){
          this.disabled = true;
          google.script.run
             .withSuccessHandler(function (returnSuccess, element) {
                 element.disabled = false;
                 changeState("state5", "state1");
             })
             .withFailureHandler(function (msg, elements) {
                 elements.disabled = false;
                 changeState("state5", "state1");
             })
             .withUserObject(this)
             .emptyFunc();
     }
     
     /**
     * Runs a server-side function to request the signature after unsuccessful attempt.
     */
     function runTryAgain(){
         this.disabled = true;
         changeState("state3", "state2");
         console.log("runSigning for user: %s", user); 
         
         google.script.run
             .withSuccessHandler(function (returnSuccess, element) {
                 console.log("Success: signature obtained (id: "+returnSuccess+")");
                 element.disabled = false;
                 signatureId = returnSuccess; 
                 changeState("state2", "state4");               
             })
             .withFailureHandler(function (msg, elements) {
                 console.log("Fail: signature was not obtained");
                 element.disabled = false;
                 changeState("state2", "state3");
             })
             .withUserObject(this)
             .requestSignature(user);
     }

    /**
     * Inserts a div that contains an error message after a given element.
     *
     * @param msg The error message to display.
     * @param element The element after which to display the error.
     */
    function showError(msg, element) {
        var div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
    }
    
    /**
     * Changes state in graphic user interface.
     *
     * @param oldName ID of element visible in previous state.
     * @param newName ID of element visible in next state
     */
    function changeState(oldName, newName){
        var oldEl = document.getElementById(oldName);
        var newEl = document.getElementById(newName);
        
        oldEl.style.display = 'none';
        newEl.style.display = 'block';
    }
</script>